#!/usr/bin/env ruby

require 'yaml'
require 'net/http'
require 'wsse'
require 'getoptlong'
$KCODE = "UTF8"
require 'kconv'
require 'getoptlong'

def atompost(target_url, user, pass, title, body, article_date, category)
  postbody = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<entry xmlns=\"http://purl.org/atom/ns#\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n"
  if title
    postbody += "<title>#{title}</title>\n"
  end
  if article_date
    postbody += "<articledate>#{article_date}</articledate>\n"
  end
  if category
    postbody += "<category>#{category.join(" ")}</category>\n"
  end
  p postbody
  if body
    postbody += "<content>#{body}</content>\n</entry>\n"
  end

  url = URI.parse(target_url)
  req = Net::HTTP::Post.new(url.path)

#  req.body = postbody ## ruby1.9 and later

  req['X-WSSE'] = WSSE.new.generate(user, pass)
  req['host'] = url.host
  req['Content-Type']= 'application/atom+xml'
  res = Net::HTTP.new(url.host, url.port).start {|http|
    http.request(req, postbody)
#    http.request(req) ## ruby1.9 and later
  }

  p res
  case res
  when Net::HTTPCreated 
    p "Success, #{article_date}"
    return res
  when Net::HTTPRedirection
    p "Redirect to res['location']"
    atompost(res['location'], user, pass, title, body, article_date)
  else
    res.error!
  end
end

def addhnf(target_url, user, pass, f)
  if f =~ /d(\d{4})(\d{2})(\d{2})\.hnf/
    ymd = $1 + '-' + $2 + '-' + $3
    hnfdate = $1 + $2 + $3

    fftmp = open(f, "r")
    mtime = fftmp.mtime
    ftmpread = fftmp.read
    ftmp = Kconv.toutf8(ftmpread).split(/\n/)
    fftmp.close
    ftmp.shift

    y = Hash.new
    y['ymd'] = ymd
    y['mtime'] = mtime
    y['text'] = ''
    daynum = 0

    ftmp.each do |x|
      if x =~ /^(CAT|NEW|LNEW)\s+.+/
        if y['title']
#          hdb.hnfinput(y)
          atompost(target_url, user, pass, y['title'], y['text'], y['ymd'], y['cat'])
          y.clear
          y['ymd'] = ymd
          y['mtime'] = mtime
          y['text'] = ''
        end
      end

      if x =~ /^CAT\s+(.+)/
        y['cat'] = $1.split(/\W+/)
        next
      end

      if x =~ /^(NEW|LNEW)\s+(.+)/
        y['title'] = $2
        daynum += 1
        y['hnfid'] = "#{hnfdate}#{daynum}"
        next
      end

      y['text'] += x + "\n"

    end
    atompost(target_url, user, pass, y['title'], y['text'], y['ymd'], y['cat'])
#    hdb.hnfinput(y)
  end
end


user = nil
pass = nil
target_url = nil
title = nil
body = nil

begin
  fconf = open("#{ENV['HOME']}/.donrails/atompost.yaml", "r")
  conf = YAML::load(fconf)
  user = conf['user']
  pass = conf['pass']
  target_url = conf['target_url']
rescue
  p $!
end


parser = GetoptLong.new
parser.set_options(['--username', '-a', GetoptLong::REQUIRED_ARGUMENT],
                   ['--password', '-d', GetoptLong::REQUIRED_ARGUMENT],
                   ['--target_url', GetoptLong::REQUIRED_ARGUMENT],
                   ['--title', '-h', GetoptLong::REQUIRED_ARGUMENT],
                   ['--body', '-u', GetoptLong::REQUIRED_ARGUMENT]
                   )
parser.each_option do |name, arg|
  case name
  when "--username"
    user = arg.to_s
  when "--password"
    pass = arg.to_s
  when "--target_url"
    target_url = arg.to_s
  when "--title"
    title = arg.to_s
  when "--body"
    body = arg.to_s
  end
end

if (body and title)
  atompost(target_url, user, pass, title, body, nil)
end

ARGV.each do |f|
  if f =~ /d\d{8}.hnf/
    # HNF 
    addhnf(target_url, user, pass, f)
  else
    p "unsupported filetype: #{f}"
  end
end
